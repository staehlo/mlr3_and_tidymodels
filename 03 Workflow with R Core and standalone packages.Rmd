---
title: "02 Workflow using R Core and standalone packages"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# some file setup parameters
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999) # display numbers in non-scientific format
```


We will use R's core packages as well as some standalone packages.

# Loading
Peek into the data set to check for value and decimal separators.
```{r}
data_url <- "https://raw.githubusercontent.com/staehlo/mlr3_and_tidymodels/main/example_data_set.csv"
writeLines(readLines(data_url, 4))
```

Load data
```{r}
loans <- read.csv2(file = data_url, header = TRUE, sep = ",", dec=".")
rm(data_url)
str(loans)
```

# Preprocessing
```{r}
loans$grade <- as.factor(loans$grade)
loans$home_ownership <- as.factor(loans$home_ownership)
loans$purpose <- as.factor(loans$purpose)
loans$grade_num <- match(loans$grade, LETTERS)
loans$monthly_payback <-round(loans$loan_amnt / loans$term, 2)
loans$term <- as.factor(loans$term) # for the classification task
str(loans)
```

Check the income distribution
```{r}
plot(loans$annual_inc, col = "maroon",
     xlab = "random order", ylab = "annual income in USD")
hist(loans$annual_inc, 50, col = "maroon")
```

We will focus on people with an annual income below 200'000 USD
```{r}
loans <- loans[loans$annual_inc < 200000,]
plot(loans$annual_inc, col = "maroon",
     xlab = "random order", ylab = "annual income in USD")
hist(loans$annual_inc, 50, col = "maroon", xlab = "annual income in USD")
```

Check the frequency of the home owner categories
```{r}
table(loans$home_ownership)
```

We will ignore the three cases with no indicated home ownership
```{r}
loans <- loans[loans$home_ownership != "NONE",]
loans <- droplevels(loans) # remove the no longer used "NONE" level
```

# Exploratory Plotting
Some boxplots for the regression task
```{r}
par.default <- par()
par(mar = c(5.1, 9, 4.1, 2.1))
barplot(table(loans$purpose), horiz=TRUE, col = "maroon", las = 1,
        xlab = "number of loans")
par(par.default)

par.default <- par()
par(mar = c(5.1, 9, 4.1, 2.1))
barplot(table(loans$home_ownership), horiz=TRUE, col = "maroon", las = 1,
        xlab = "number of loans")
par(par.default)

# create a random sub sample for the plots
set.seed(123)
tmp <- loans[sample(nrow(loans), 1000),]

plot(tmp$annual_inc, tmp$int_rate, col = "maroon",
     xlab = "annual income in USD", ylab = "interest rate in percent")

plot(tmp$loan_amnt, tmp$int_rate, col = "maroon",
     xlab = "requested loan in USD", ylab = "interest rate in percent")

boxplot(int_rate ~ home_ownership, tmp, col = "maroon",
        xlab = "", ylab = "interest rate in percent")

par.default <- par()
par(mar = c(7, 4.1, 4.1, 2.1))
x <- boxplot(int_rate ~ purpose, tmp, col = "maroon",
        xlab = "", ylab = "interest rate in percent", xaxt = "n")
nlevels = length(levels(tmp$purpose))
text(x = (1:nlevels)-0.4, y = 2, labels = x$names, xpd=NA, srt = 45)
par(par.default)

x <- boxplot(int_rate ~ grade, tmp, col = "maroon",
             ylab = "interest rate in percent")

rm(x, nlevels, tmp, par.default)
```

# Regression
Estimating the proposed interest rate
```{r}
set.seed(123)
rows_for_training <- sample(nrow(loans), 0.8 * nrow(loans))
train <- loans[rows_for_training,]
test <- loans[-rows_for_training,]
lm.fit <- lm(int_rate ~ loan_amnt + annual_inc + grade_num + home_ownership + purpose,
          data = train)
summary(lm.fit)
results <- c()
results["r.squared.train"] <- 100 * summary(lm.fit)$r.squared

# only for better summary of results
library(car)
Anova(lm.fit, type = "III")

# Compute R-Squared of test data set
test.estimations <- predict(lm.fit, test)
# No sure if this step is correct:
results["r.squared.test"] <- 100 * (cor(test$int_rate, test.estimations))^2

# Compute Root Mean Squared Error (RMSE)
results["RMSE.train"] <- sqrt(mean((train$int_rate - lm.fit$fitted.values)^2))
results["RMSE.test"] <- sqrt(mean((test$int_rate - test.estimations)^2))

rm(train, test, rows_for_training, test.estimations, lm.fit)
```

## Result
```{r}
df <- t(data.frame(as.list(round(results, 3))))
print(df)
rm(df, results)
```
> print(df)
                  [,1]
r.squared.train 90.234
r.squared.test  89.829
RMSE.train       1.164
RMSE.test        1.175


# Classification
Predicting the loan term (3 or 5 years)

## Logistic regression
```{r}
set.seed(123)
rows_for_training <- sample(nrow(loans), 0.8 * nrow(loans))
train <- loans[rows_for_training,]
test <- loans[-rows_for_training,]

glm.fit <- glm(term ~ int_rate + loan_amnt + annual_inc + grade_num + home_ownership + purpose,
          data = train, family = binomial)
summary(glm.fit)

error.rates <- c()

train.probabilities <- predict(glm.fit, type = "response")
train.predictions <- rep("36", nrow(train))
contrasts(train$term)
train.predictions[train.probabilities > 0.5] = "60"
table(train.predictions, train$term)
error.rates["logistic.train"] <- mean(train.predictions != train$term)

test.probabilities <- predict(glm.fit, test, type = "response")
test.predictions <- rep("36", nrow(test))
test.predictions[test.probabilities > 0.5] = "60"
table(test.predictions, test$term)
error.rates["logistic.test"] <- mean(test.predictions != test$term)

rm(glm.fit, rows_for_training, test.predictions, test.probabilities,
   train.predictions, train.probabilities)
```


## Random forest
```{r}
set.seed(123)
rows_for_training <- sample(nrow(loans), 0.8 * nrow(loans))
train <- loans[rows_for_training,]
test <- loans[-rows_for_training,]

library(randomForest)
mtry <- sqrt(6) # mtry = number of predictors used at each node
                # rule of thumb: mtry = sqrt(number of predictors)
rf.fit <- randomForest(term ~ int_rate + loan_amnt + annual_inc + grade_num + home_ownership + purpose,
          data = train, mtry = mtry, importance = TRUE)
rf.fit
error.rates["random_forest.train"] <- mean(rf.fit$predicted != train$term)

rf.test.predictions <- predict(rf.fit, newdata = test)
table(rf.test.predictions, test$term)
error.rates["random_forest.test"] <- mean(rf.test.predictions != test$term)

rm(rows_for_training, test, train, mtry, rf.fit, rf.test.predictions)

```

## Comparison
```{r}
print(error.rates)

df <- t(data.frame(as.list(round(error.rates * 100, 2))))
dimnames(df)[[2]] <- "error in %"
print(df)
rm(df, error.rates)
```

## Result
> print(df)
                    error in %
logistic.train           19.01
logistic.test            18.91
random_forest.train      16.69
random_forest.test       16.53
